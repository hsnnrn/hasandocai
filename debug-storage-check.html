<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storage Debug Tool</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #000;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #333;
    }
    pre {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 6px;
      overflow: auto;
      max-height: 600px;
      font-size: 12px;
    }
    .summary {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin: 15px 0;
    }
    .error {
      background: #ffebee;
      border-left: 4px solid #f44336;
      padding: 15px;
      margin: 15px 0;
    }
    .success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 15px;
      margin: 15px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f5f5f5;
      font-weight: 600;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-analysis { background: #e3f2fd; color: #1976d2; }
    .badge-embedding { background: #f3e5f5; color: #7b1fa2; }
    .badge-bge { background: #e8f5e9; color: #388e3c; }
    .badge-warning { background: #fff3e0; color: #f57c00; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📊 Persistent Storage Debug Tool</h1>
    <p>Bu araç persistent storage'daki tüm verileri gösterir ve chatbot'un neden bazı dökümanları görmediğini anlamanıza yardımcı olur.</p>
    
    <div>
      <button onclick="checkStorage()">🔍 Storage Kontrolü</button>
      <button onclick="checkChatbotData()">💬 Chatbot Verileri</button>
      <button onclick="clearResults()">🗑️ Temizle</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    async function checkStorage() {
      const results = document.getElementById('results');
      results.innerHTML = '<div class="summary">⏳ Veriler yükleniyor...</div>';

      try {
        // Get all data from persistent storage
        const response = await window.electronAPI.persistentStorage.getAllData();
        
        if (!response || !response.success) {
          results.innerHTML = '<div class="error">❌ Veri alınamadı: ' + (response?.error || 'Bilinmeyen hata') + '</div>';
          return;
        }

        const allData = response.data || [];
        
        // Analyze data
        const analysis = {
          total: allData.length,
          byType: {},
          byModel: {},
          bySource: {},
          analysisItems: []
        };

        allData.forEach(item => {
          // Count by type
          analysis.byType[item.type] = (analysis.byType[item.type] || 0) + 1;
          
          // Count by model
          if (item.metadata?.model) {
            analysis.byModel[item.metadata.model] = (analysis.byModel[item.metadata.model] || 0) + 1;
          }
          
          // Count by source
          if (item.metadata?.source) {
            analysis.bySource[item.metadata.source] = (analysis.bySource[item.metadata.source] || 0) + 1;
          }

          // Collect analysis items
          if (item.type === 'analysis') {
            analysis.analysisItems.push({
              id: item.id,
              filename: item.content?.filename || 'Unknown',
              model: item.metadata?.model || 'Unknown',
              source: item.metadata?.source || 'Unknown',
              hasContent: !!item.content,
              hasTextSections: !!item.content?.textSections,
              textSectionsCount: item.content?.textSections?.length || 0,
              timestamp: item.metadata?.timestamp
            });
          }
        });

        // Display summary
        let html = `
          <div class="summary">
            <h3>📈 Genel Özet</h3>
            <p><strong>Toplam Veri:</strong> ${analysis.total} item</p>
          </div>

          <div class="summary">
            <h3>📁 Tip Bazında Dağılım</h3>
            <table>
              <tr><th>Tip</th><th>Adet</th></tr>
              ${Object.entries(analysis.byType).map(([type, count]) => `
                <tr>
                  <td><span class="badge badge-${type}">${type}</span></td>
                  <td>${count}</td>
                </tr>
              `).join('')}
            </table>
          </div>

          <div class="summary">
            <h3>🤖 Model Bazında Dağılım</h3>
            <table>
              <tr><th>Model</th><th>Adet</th></tr>
              ${Object.entries(analysis.byModel).map(([model, count]) => `
                <tr>
                  <td><span class="badge badge-${model === 'BGE-M3' ? 'bge' : 'analysis'}">${model}</span></td>
                  <td>${count}</td>
                </tr>
              `).join('')}
            </table>
          </div>

          <div class="summary">
            <h3>📄 Analysis Items (Chatbot'un Görebileceği Veriler)</h3>
            <p><strong>Toplam Analysis:</strong> ${analysis.analysisItems.length} item</p>
            <table>
              <tr>
                <th>Dosya Adı</th>
                <th>Model</th>
                <th>Source</th>
                <th>Text Sections</th>
                <th>Durum</th>
              </tr>
              ${analysis.analysisItems.map(item => {
                const isValid = item.hasContent && item.hasTextSections && item.textSectionsCount > 0;
                const isBGE = item.model === 'BGE-M3' && item.source === 'document-analysis';
                return `
                  <tr>
                    <td><strong>${item.filename}</strong></td>
                    <td><span class="badge badge-${isBGE ? 'bge' : 'analysis'}">${item.model}</span></td>
                    <td>${item.source}</td>
                    <td>${item.textSectionsCount}</td>
                    <td>
                      ${isValid 
                        ? '<span class="badge badge-bge">✅ Geçerli</span>' 
                        : '<span class="badge badge-warning">⚠️ Eksik</span>'}
                      ${isBGE 
                        ? '<span class="badge badge-bge">✅ BGE-M3</span>' 
                        : '<span class="badge badge-warning">⚠️ BGE Değil</span>'}
                    </td>
                  </tr>
                `;
              }).join('')}
            </table>
          </div>

          <div class="summary">
            <h3>🔍 Sorun Tespiti</h3>
            ${analysis.analysisItems.filter(item => !item.hasTextSections || item.textSectionsCount === 0).length > 0 ? `
              <div class="error">
                <p><strong>⚠️ Aşağıdaki dökümanlar textSections içermiyor:</strong></p>
                <ul>
                  ${analysis.analysisItems
                    .filter(item => !item.hasTextSections || item.textSectionsCount === 0)
                    .map(item => `<li>${item.filename} (Model: ${item.model})</li>`)
                    .join('')}
                </ul>
                <p>Bu dökümanlar chatbot tarafından görülmeyecektir.</p>
              </div>
            ` : `
              <div class="success">
                <p>✅ Tüm analysis dökümanları textSections içeriyor!</p>
              </div>
            `}

            ${analysis.analysisItems.filter(item => item.model !== 'BGE-M3').length > 0 ? `
              <div class="error">
                <p><strong>⚠️ Aşağıdaki dökümanlar BGE-M3 modeli kullanmıyor:</strong></p>
                <ul>
                  ${analysis.analysisItems
                    .filter(item => item.model !== 'BGE-M3')
                    .map(item => `<li>${item.filename} (Model: ${item.model})</li>`)
                    .join('')}
                </ul>
                <p>ChatBot öncelikle BGE-M3 verilerini kullanır. BGE-M3 verisi yoksa diğer analysis verilerini kullanır.</p>
              </div>
            ` : ''}
          </div>

          <details>
            <summary><strong>📋 Ham Veri (JSON)</strong></summary>
            <pre>${JSON.stringify(allData, null, 2)}</pre>
          </details>
        `;

        results.innerHTML = html;

      } catch (error) {
        results.innerHTML = `<div class="error">❌ Hata: ${error.message}</div>`;
        console.error('Storage check error:', error);
      }
    }

    async function checkChatbotData() {
      const results = document.getElementById('results');
      results.innerHTML = '<div class="summary">⏳ Chatbot verileri kontrol ediliyor...</div>';

      try {
        // Simulate what chatbot does
        const aiDataResult = await window.electronAPI.persistentStorage.getAllData();
        
        if (!aiDataResult || !aiDataResult.success) {
          results.innerHTML = '<div class="error">❌ Veri alınamadı</div>';
          return;
        }

        const allData = aiDataResult.data || [];

        // STEP 1: Filter all analysis data (no model filter)
        const allAnalysisData = allData.filter(item => {
          const isAnalysis = item.type === 'analysis';
          const hasContent = !!item.content;
          const hasTextSections = !!item.content?.textSections;
          return isAnalysis && hasContent && hasTextSections;
        });

        // STEP 2: Filter BGE-M3 data
        const bgeAnalysisData = allData.filter(item => 
          item.type === 'analysis' && 
          item.metadata?.model === 'BGE-M3' &&
          item.metadata?.source === 'document-analysis' &&
          item.content && 
          item.content.textSections
        );

        // STEP 3: Use BGE-M3 if available, otherwise use all analysis
        const analysisData = bgeAnalysisData.length > 0 ? bgeAnalysisData : allAnalysisData;

        // STEP 4: Convert to LOCAL_DOCS format
        const localDocs = analysisData.map(item => {
          const content = item.content;
          const textSections = content.textSections || [];
          
          return {
            documentId: content.documentId || item.id,
            title: content.title || content.filename || item.id,
            filename: content.filename || 'unknown',
            fileType: content.fileType || 'UNKNOWN',
            textSections: textSections
          };
        }).filter(doc => doc.textSections.length > 0);

        // Display results
        let html = `
          <div class="summary">
            <h3>🤖 Chatbot'un Gördüğü Veriler</h3>
            <p><strong>Toplam Veri:</strong> ${allData.length}</p>
            <p><strong>Analysis Verisi (tümü):</strong> ${allAnalysisData.length}</p>
            <p><strong>BGE-M3 Analysis:</strong> ${bgeAnalysisData.length}</p>
            <p><strong>Kullanılan Veri:</strong> ${analysisData.length} ${bgeAnalysisData.length > 0 ? '(BGE-M3)' : '(Tümü)'}</p>
            <p><strong>Chatbot'a Gönderilen Döküman:</strong> ${localDocs.length}</p>
          </div>

          ${localDocs.length > 0 ? `
            <div class="success">
              <h3>✅ Chatbot Bu Dökümanları Görebiliyor:</h3>
              <table>
                <tr>
                  <th>Dosya Adı</th>
                  <th>Tip</th>
                  <th>Text Sections</th>
                </tr>
                ${localDocs.map(doc => `
                  <tr>
                    <td><strong>${doc.filename}</strong></td>
                    <td>${doc.fileType}</td>
                    <td>${doc.textSections.length}</td>
                  </tr>
                `).join('')}
              </table>
            </div>
          ` : `
            <div class="error">
              <p>❌ Chatbot hiçbir döküman göremiyor!</p>
            </div>
          `}

          ${localDocs.length < allAnalysisData.length ? `
            <div class="error">
              <h3>⚠️ Eksik Dökümanlar:</h3>
              <p>Toplam ${allAnalysisData.length} analysis verisi var ama chatbot sadece ${localDocs.length} tanesini görebiliyor.</p>
              <p><strong>Neden?</strong></p>
              <ul>
                <li>textSections boş olabilir</li>
                <li>textSections.length === 0 olabilir</li>
                <li>content veya metadata eksik olabilir</li>
              </ul>
            </div>
          ` : ''}

          <details>
            <summary><strong>📋 Chatbot LOCAL_DOCS (JSON)</strong></summary>
            <pre>${JSON.stringify(localDocs, null, 2)}</pre>
          </details>
        `;

        results.innerHTML = html;

      } catch (error) {
        results.innerHTML = `<div class="error">❌ Hata: ${error.message}</div>`;
        console.error('Chatbot data check error:', error);
      }
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }
  </script>
</body>
</html>

