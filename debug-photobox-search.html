<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoBox Arama Debug</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .info {
            color: #3498db;
            font-weight: bold;
        }
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            background: white;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-left: 10px;
        }
        .status.pass {
            background: #d4edda;
            color: #155724;
        }
        .status.fail {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 PhotoBox Arama Debug Tool</h1>
        
        <div class="section">
            <h2>📊 Test Adımları</h2>
            <p>Bu tool, "photobox" aramasının neden photobox360_setup.pdf dosyasını bulmadığını anlamanıza yardımcı olur.</p>
            
            <button onclick="step1_checkDocs()">1️⃣ Belgeleri Kontrol Et</button>
            <button onclick="step2_testNormalization()">2️⃣ Normalizasyon Test</button>
            <button onclick="step3_testMatching()">3️⃣ Eşleştirme Test</button>
            <button onclick="step4_fullSearch()">4️⃣ Tam Arama Yap</button>
            <button onclick="clearResults()">🗑️ Temizle</button>
        </div>

        <div class="section">
            <h2>📋 Test Sonuçları</h2>
            <div id="results" class="results">Test başlatmak için yukarıdaki butonlara tıklayın...</div>
        </div>
    </div>

    <script>
        let logOutput = '';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('tr-TR');
            const colors = {
                success: '#27ae60',
                error: '#e74c3c',
                info: '#3498db',
                warn: '#f39c12'
            };
            const color = colors[type] || colors.info;
            logOutput += `<div class="log-entry" style="border-left: 3px solid ${color};">[${timestamp}] ${message}</div>`;
            updateResults();
        }

        function updateResults() {
            document.getElementById('results').innerHTML = logOutput || 'Henüz log yok...';
            document.getElementById('results').scrollTop = document.getElementById('results').scrollHeight;
        }

        function clearResults() {
            logOutput = '';
            updateResults();
        }

        // Step 1: Check documents in localStorage
        async function step1_checkDocs() {
            log('=== ADIM 1: Belgeleri Kontrol Et ===', 'info');
            
            try {
                const result = await window.electronAPI.persistentStorage.getAllData();
                
                if (!result.success) {
                    log('❌ Belge yükleme BAŞARISIZ: ' + result.error, 'error');
                    return;
                }

                const analysisData = result.data.filter(item => item.type === 'analysis');
                log(`✅ Toplam ${analysisData.length} analiz belgesi bulundu`, 'success');

                analysisData.forEach((item, idx) => {
                    const filename = item.content?.filename || 'unknown';
                    const sections = item.content?.textSections?.length || 0;
                    
                    if (filename.toLowerCase().includes('photobox')) {
                        log(`  ${idx + 1}. 📄 ${filename} (${sections} bölüm) <span class="status pass">✓ PHOTOBOX</span>`, 'success');
                    } else {
                        log(`  ${idx + 1}. 📄 ${filename} (${sections} bölüm)`, 'info');
                    }
                });

                const hasPhotobox = analysisData.some(item => 
                    item.content?.filename?.toLowerCase().includes('photobox')
                );

                if (hasPhotobox) {
                    log('✅ PhotoBox dosyası localStorage\'da VAR!', 'success');
                } else {
                    log('❌ PhotoBox dosyası localStorage\'da YOK!', 'error');
                }

            } catch (error) {
                log('❌ Hata: ' + error.message, 'error');
            }
        }

        // Step 2: Test normalization
        async function step2_testNormalization() {
            log('=== ADIM 2: Normalizasyon Test ===', 'info');
            
            const filenames = [
                'photobox360_setup.pdf',
                'Invoice-13TVEI4D-0002.docx',
                'Invoice-13TVEI4D-0002.pdf'
            ];

            function normalizeTurkish(text) {
                return text
                    .toLowerCase()
                    .replace(/ı/g, 'i')
                    .replace(/İ/g, 'i')
                    .replace(/ğ/g, 'g')
                    .replace(/ü/g, 'u')
                    .replace(/ş/g, 's')
                    .replace(/ö/g, 'o')
                    .replace(/ç/g, 'c')
                    .trim();
            }

            function normalizeFilename(filename) {
                const withoutExt = filename.replace(/\.(pdf|docx?|xlsx?|pptx?|txt)$/i, '');
                const hasIDPattern = /[a-zA-Z]+-[a-zA-Z0-9]+/i.test(withoutExt);
                
                if (hasIDPattern) {
                    return normalizeTurkish(withoutExt);
                } else {
                    return normalizeTurkish(withoutExt.replace(/[-_]/g, ' '));
                }
            }

            filenames.forEach(filename => {
                const normalized = normalizeFilename(filename);
                const words = normalized.split(/[\s\-_]+/).filter(w => w.length > 2);
                log(`📄 "${filename}"`, 'info');
                log(`   → Normalized: "${normalized}"`, 'info');
                log(`   → Words: [${words.join(', ')}]`, 'info');
            });

            log('✅ Normalizasyon test tamamlandı', 'success');
        }

        // Step 3: Test matching algorithm
        async function step3_testMatching() {
            log('=== ADIM 3: Eşleştirme Algoritması Test ===', 'info');
            
            const query = 'photobox';
            const queryWords = query.toLowerCase().split(/[\s\-_]+/).filter(w => w.length > 2);
            
            log(`🔍 Query: "${query}"`, 'info');
            log(`📝 Query words: [${queryWords.join(', ')}]`, 'info');

            const testFiles = [
                { name: 'photobox360_setup.pdf', words: ['photobox360', 'setup'] },
                { name: 'Invoice-13TVEI4D-0002.docx', words: ['invoice', '13tvei4d', '0002'] },
            ];

            testFiles.forEach(file => {
                log(`\n📄 Testing: "${file.name}"`, 'info');
                
                let bestMatchScore = 0;
                let bestMatchType = 'none';

                queryWords.forEach(qw => {
                    file.words.forEach(fw => {
                        let matchScore = 0;
                        let matchType = '';

                        if (qw === fw) {
                            matchScore = 1.0;
                            matchType = 'EXACT';
                        } else if (fw.startsWith(qw) && qw.length >= 4) {
                            matchScore = 0.95 - (fw.length - qw.length) * 0.05;
                            matchType = 'PREFIX';
                        } else if (fw.includes(qw) && qw.length >= 4) {
                            matchScore = 0.85;
                            matchType = 'CONTAINS';
                        }

                        if (matchScore > bestMatchScore) {
                            bestMatchScore = matchScore;
                            bestMatchType = matchType;
                        }

                        if (matchScore > 0) {
                            log(`   ✓ "${qw}" ~ "${fw}" → ${matchType} (score: ${matchScore.toFixed(2)})`, 'success');
                        }
                    });
                });

                if (bestMatchScore > 0) {
                    log(`   <span class="status pass">MATCH: ${bestMatchType} (score: ${bestMatchScore.toFixed(2)})</span>`, 'success');
                } else {
                    log(`   <span class="status fail">NO MATCH</span>`, 'error');
                }
            });

            log('\n✅ Eşleştirme test tamamlandı', 'success');
        }

        // Step 4: Full search test
        async function step4_fullSearch() {
            log('=== ADIM 4: Tam Arama Test ===', 'info');
            
            const query = 'photobox';
            log(`🔍 Searching for: "${query}"`, 'info');

            try {
                // Simulate document chat query
                const result = await window.electronAPI.persistentStorage.getAllData();
                
                if (!result.success) {
                    log('❌ Belge yükleme hatası', 'error');
                    return;
                }

                const localDocs = result.data
                    .filter(item => item.type === 'analysis' && item.content?.textSections?.length > 0)
                    .map(item => ({
                        documentId: item.content.documentId || item.id,
                        title: item.content.title || item.content.filename,
                        filename: item.content.filename || 'unknown',
                        fileType: item.content.fileType || 'UNKNOWN',
                        textSections: item.content.textSections || []
                    }));

                log(`📊 Total documents: ${localDocs.length}`, 'info');

                // Manual matching test
                localDocs.forEach(doc => {
                    const filename = doc.filename.toLowerCase();
                    const filenameWithoutExt = filename.replace(/\.(pdf|docx?|xlsx?|pptx?|txt)$/i, '');
                    const words = filenameWithoutExt.split(/[\s\-_]+/).filter(w => w.length > 2);
                    
                    let matched = false;
                    let matchType = '';

                    words.forEach(word => {
                        if (word === query) {
                            matched = true;
                            matchType = 'EXACT';
                        } else if (word.startsWith(query) && query.length >= 4) {
                            matched = true;
                            matchType = 'PREFIX';
                        }
                    });

                    if (matched) {
                        log(`   ✅ MATCH: ${doc.filename} (${matchType}) <span class="status pass">✓ FOUND</span>`, 'success');
                    } else {
                        log(`   ❌ NO MATCH: ${doc.filename}`, 'error');
                    }
                });

                log('\n✅ Tam arama test tamamlandı', 'success');

            } catch (error) {
                log('❌ Hata: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>

